name: CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22'
  NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ vars.NEXT_PUBLIC_SANITY_PROJECT_ID }}
  NEXT_PUBLIC_SANITY_DATASET: ${{ vars.NEXT_PUBLIC_SANITY_DATASET }}

jobs:
  # ─── Fast quality gate (lint + typecheck) ───
  quality:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm lint
      - run: pnpm typecheck

  # ─── Security scanning ───
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

      - name: Dependency audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Secret pattern scan
        run: |
          echo "Scanning for leaked secrets in source..."
          PATTERNS='sk_live_|sk_test_|AKIA[0-9A-Z]{16}|-----BEGIN (RSA |EC )?PRIVATE KEY|ghp_[a-zA-Z0-9]{36}|glpat-[a-zA-Z0-9\-]{20}'
          MATCHES=$(grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" --include="*.json" -E "$PATTERNS" . \
            --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=.git || true)
          if [ -n "$MATCHES" ]; then
            echo "::error::Potential secrets found in source code!"
            echo "$MATCHES"
            exit 1
          fi
          echo "No secrets detected."

      - name: Semgrep SAST
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/nextjs
        continue-on-error: true

  # ─── Build verification ───
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm build

      - name: Bundle size check
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo '| File | Size |' >> $GITHUB_STEP_SUMMARY
          echo '|------|------|' >> $GITHUB_STEP_SUMMARY

          WARN=0
          FAIL=0

          for f in $(find .next/static/chunks -name "*.js" -type f 2>/dev/null | sort); do
            SIZE=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null || echo "0")
            SIZE_KB=$((SIZE / 1024))
            NAME=$(basename "$f")

            if [ "$SIZE_KB" -gt 750 ]; then
              echo "| \`$NAME\` | **${SIZE_KB}KB** :x: |" >> $GITHUB_STEP_SUMMARY
              FAIL=$((FAIL + 1))
            elif [ "$SIZE_KB" -gt 500 ]; then
              echo "| \`$NAME\` | **${SIZE_KB}KB** :warning: |" >> $GITHUB_STEP_SUMMARY
              WARN=$((WARN + 1))
            elif [ "$SIZE_KB" -gt 200 ]; then
              echo "| \`$NAME\` | ${SIZE_KB}KB |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Chunks > 500KB: $WARN warnings, $FAIL failures" >> $GITHUB_STEP_SUMMARY

          if [ "$FAIL" -gt 0 ]; then
            echo "::warning::$FAIL chunk(s) exceed 750KB — consider code-splitting"
          fi

  # ─── E2E tests ───
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v6
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

      - name: Cache Playwright
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      - run: pnpm exec playwright install chromium --with-deps
      - name: Build and run E2E tests
        run: |
          pnpm build
          pnpm exec playwright test --project=chromium

      - name: Upload failure artifacts
        uses: actions/upload-artifact@v6
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # ─── Summary (always runs) ───
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality, security, build, e2e]
    if: always()
    steps:
      - name: Evaluate results
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo '| Job | Status |' >> $GITHUB_STEP_SUMMARY
          echo '|-----|--------|' >> $GITHUB_STEP_SUMMARY

          FAILED=0

          check_job() {
            local name="$1"
            local result="$2"
            if [ "$result" = "success" ]; then
              echo "| $name | :white_check_mark: passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "$result" = "skipped" ]; then
              echo "| $name | :fast_forward: skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $name | :x: $result |" >> $GITHUB_STEP_SUMMARY
              FAILED=$((FAILED + 1))
            fi
          }

          check_job "Quality" "${{ needs.quality.result }}"
          check_job "Security" "${{ needs.security.result }}"
          check_job "Build" "${{ needs.build.result }}"
          check_job "E2E Tests" "${{ needs.e2e.result }}"

          if [ "$FAILED" -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo ":x: **$FAILED job(s) failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo ":white_check_mark: **All checks passed**" >> $GITHUB_STEP_SUMMARY
