name: Deploy Production

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  verify:
    name: Verify Vercel Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Wait for Vercel deployment
        run: |
          echo "⏳ Waiting for Vercel to deploy..."
          echo "Vercel's GitHub integration handles deployments automatically."
          sleep 60

      - name: Health check
        run: |
          PROD_URL="https://steelmotionllc.com"
          echo "Checking $PROD_URL..."

          # Retry up to 5 times with 30s intervals
          for i in 1 2 3 4 5; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$PROD_URL" --max-time 30 || echo "000")
            echo "Attempt $i: HTTP $HTTP_STATUS"

            if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
              echo "✅ Production is healthy ($HTTP_STATUS)"
              exit 0
            fi

            if [ $i -lt 5 ]; then
              echo "Retrying in 30s..."
              sleep 30
            fi
          done

          echo "::warning::Production health check failed after 5 attempts"

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** https://steelmotionllc.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Vercel's GitHub integration handles the actual deployment." >> $GITHUB_STEP_SUMMARY
          echo "This workflow verifies the deployment succeeded." >> $GITHUB_STEP_SUMMARY
