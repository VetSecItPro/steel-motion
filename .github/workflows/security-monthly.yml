name: Monthly Security Scan

on:
  schedule:
    - cron: '30 6 1-7 * *' # Days 1-7 of each month at 12:30 AM CST (6:30 AM UTC)
  workflow_dispatch: # Manual trigger support

env:
  NODE_VERSION: '22'

permissions:
  contents: read
  security-events: write
  issues: write

jobs:
  check-day:
    name: Check if Saturday
    runs-on: ubuntu-latest
    outputs:
      is_saturday: ${{ steps.check.outputs.is_saturday }}
    steps:
      - name: Check if today is Saturday
        id: check
        run: |
          DAY=$(date +%u)
          if [ "$DAY" -eq 6 ]; then
            echo "is_saturday=true" >> $GITHUB_OUTPUT
          else
            echo "is_saturday=false" >> $GITHUB_OUTPUT
          fi

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    needs: check-day
    if: needs.check-day.outputs.is_saturday == 'true'
    outputs:
      critical: ${{ steps.audit.outputs.critical }}
      high: ${{ steps.audit.outputs.high }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

      - name: Full audit
        id: audit
        run: |
          echo "## Dependency Audit" >> $GITHUB_STEP_SUMMARY
          pnpm audit --json > audit-results.json 2>/dev/null || true
          CRITICAL=$(jq '[.advisories // {} | to_entries[] | select(.value.severity == "critical")] | length' audit-results.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.advisories // {} | to_entries[] | select(.value.severity == "high")] | length' audit-results.json 2>/dev/null || echo "0")
          echo "Critical: $CRITICAL, High: $HIGH" >> $GITHUB_STEP_SUMMARY

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::$CRITICAL critical vulnerabilities found"
          fi

      - name: Check outdated packages
        run: |
          echo "## Outdated Packages" >> $GITHUB_STEP_SUMMARY
          pnpm outdated --format json 2>/dev/null | jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.latest)"' >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "All packages up to date" >> $GITHUB_STEP_SUMMARY

  semgrep-deep:
    name: Semgrep Deep Scan
    runs-on: ubuntu-latest
    needs: check-day
    if: needs.check-day.outputs.is_saturday == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Semgrep SAST (extended rules)
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/owasp-top-ten
            p/nextjs
            p/react
            p/typescript

  license-check:
    name: License Check
    runs-on: ubuntu-latest
    needs: check-day
    if: needs.check-day.outputs.is_saturday == 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
      - run: pnpm install --frozen-lockfile

      - name: Check licenses
        run: |
          npx license-checker --production --excludePrivatePackages --json > licenses.json 2>/dev/null || true
          echo "## License Report" >> $GITHUB_STEP_SUMMARY

          BANNED='GPL-3.0|AGPL|SSPL|BSL|EUPL'
          FLAGGED=$(jq -r 'to_entries[] | select(.value.licenses | test("'"$BANNED"'")) | "\(.key): \(.value.licenses)"' licenses.json 2>/dev/null || true)

          if [ -n "$FLAGGED" ]; then
            echo "::warning::Potentially problematic licenses found:"
            echo "$FLAGGED" >> $GITHUB_STEP_SUMMARY
          else
            echo "All dependencies use approved licenses." >> $GITHUB_STEP_SUMMARY
          fi

  create-issue:
    name: Create Summary Issue
    runs-on: ubuntu-latest
    needs: [check-day, dependency-audit]
    if: needs.check-day.outputs.is_saturday == 'true' && (fromJSON(needs.dependency-audit.outputs.critical) > 0 || fromJSON(needs.dependency-audit.outputs.high) > 0)
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const critical = ${{ needs.dependency-audit.outputs.critical || 0 }};
            const high = ${{ needs.dependency-audit.outputs.high || 0 }};
            const date = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Steel Motion Security] ${critical} critical, ${high} high - ${date}`,
              labels: ['security', 'automated', 'monthly-scan'],
              body: `## ðŸ”’ Monthly Security Scan - Steel Motion

**Scan Date:** ${new Date().toLocaleDateString()}
**Workflow:** [View Run](${context.payload.repository.html_url}/actions/runs/${context.runId})

### Vulnerability Summary
- ðŸ”´ Critical: ${critical}
- ðŸŸ  High: ${high}

### Next Steps
Run \`/sec-weekly-scan --repo steelmotion --fix-only\` to strategically analyze and fix these issues.

The skill will:
1. Analyze each vulnerability for breaking changes
2. Auto-fix safe items with build validation
3. Create PR for fixes
4. Auto-merge if CI passes

---
*This issue was created automatically by the monthly security scan.*
            });

  summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [check-day, dependency-audit, semgrep-deep, license-check]
    if: always() && needs.check-day.outputs.is_saturday == 'true'
    steps:
      - name: Summary
        run: |
          echo "## Monthly Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo '| Check | Status |' >> $GITHUB_STEP_SUMMARY
          echo '|-------|--------|' >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Audit | ${{ needs.dependency-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep SAST | ${{ needs.semgrep-deep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
